require 'spec_helper'

describe Reportability do
  let(:input) do
    [{"key"=>{"date_booked"=>{"y"=>2012, "m"=>8}, "provider"=>"REZROOMZ", "tlc"=>"MUC"}, "count"=>1}, {"key"=>{"date_booked"=>{"y"=>2012, "m"=>11}, "provider"=>"EUROTOURS", "tlc"=>"INN"}, "count"=>5}, {"key"=>{"date_booked"=>{"y"=>2012, "m"=>8}, "provider"=>"GTA", "tlc"=>"LON"}, "count"=>1}, {"key"=>{"date_booked"=>{"y"=>2012, "m"=>8}, "provider"=>"HOTELBEDS", "tlc"=>"BER"}, "count"=>4}, {"key"=>{"date_booked"=>{"y"=>2012, "m"=>8}, "provider"=>"HOTELBEDS", "tlc"=>"HAM"}, "count"=>2}, {"key"=>{"date_booked"=>{"y"=>2012, "m"=>8}, "provider"=>"MIKI", "tlc"=>"BER"}, "count"=>1}, {"key"=>{"date_booked"=>{"y"=>2012, "m"=>8}, "provider"=>"REZROOMZ", "tlc"=>"BER"}, "count"=>25}, {"key"=>{"date_booked"=>{"y"=>2012, "m"=>8}, "provider"=>"GTA", "tlc"=>"MEX"}, "count"=>1}, {"key"=>{"date_booked"=>{"y"=>2012, "m"=>8}, "provider"=>"TOURICO", "tlc"=>"BER"}, "count"=>1}, {"key"=>{"date_booked"=>{"y"=>2012, "m"=>10}, "provider"=>"WOTRA", "tlc"=>"BZO"}, "count"=>1}, {"key"=>{"date_booked"=>{"y"=>2012, "m"=>12}, "provider"=>"WOTRA", "tlc"=>"BUD"}, "count"=>1}, {"key"=>{"date_booked"=>{"y"=>2012, "m"=>8}, "provider"=>"GTA", "tlc"=>"BER"}, "count"=>8}, {"key"=>{"date_booked"=>{"y"=>2012, "m"=>12}, "provider"=>"GTA", "tlc"=>"WRO"}, "count"=>2}, {"key"=>{"date_booked"=>{"y"=>2012, "m"=>10}, "provider"=>"REZROOMZ", "tlc"=>"BER"}, "count"=>4}, {"key"=>{"date_booked"=>{"y"=>2012, "m"=>8}, "provider"=>"REZROOMZ", "tlc"=>"ESS"}, "count"=>1}, {"key"=>{"date_booked"=>{"y"=>2012, "m"=>11}, "provider"=>"WOTRA", "tlc"=>"MUN"}, "count"=>1}, {"key"=>{"date_booked"=>{"y"=>2012, "m"=>9}, "provider"=>"GTA", "tlc"=>"WRO"}, "count"=>3}, {"key"=>{"date_booked"=>{"y"=>2012, "m"=>11}, "provider"=>"WOTRA", "tlc"=>"BZO"}, "count"=>51}, {"key"=>{"date_booked"=>{"y"=>2012, "m"=>8}, "provider"=>"HOTELBEDS", "tlc"=>"MUC"}, "count"=>1}, {"key"=>{"date_booked"=>{"y"=>2012, "m"=>8}, "provider"=>"REZROOMZ", "tlc"=>"LON"}, "count"=>1}, {"key"=>{"date_booked"=>{"y"=>2012, "m"=>10}, "provider"=>"REZROOMZ", "tlc"=>"WRO"}, "count"=>6}, {"key"=>{"date_booked"=>{"y"=>2012, "m"=>8}, "provider"=>"REZROOMZ", "tlc"=>"MGL"}, "count"=>1}, {"key"=>{"date_booked"=>{"y"=>2012, "m"=>8}, "provider"=>"KUONI", "tlc"=>"RSE"}, "count"=>6}, {"key"=>{"date_booked"=>{"y"=>2012, "m"=>8}, "provider"=>"GTA", "tlc"=>"BKK"}, "count"=>2}, {"key"=>{"date_booked"=>{"y"=>2012, "m"=>12}, "provider"=>"WOTRA", "tlc"=>"VIE"}, "count"=>1}, {"key"=>{"date_booked"=>{"y"=>2012, "m"=>9}, "provider"=>"JACTRAVEL", "tlc"=>"BER"}, "count"=>1}, {"key"=>{"date_booked"=>{"y"=>2012, "m"=>8}, "provider"=>"KUONI", "tlc"=>"BER"}, "count"=>1}, {"key"=>{"date_booked"=>{"y"=>2012, "m"=>8}, "provider"=>"REZROOMZ", "tlc"=>"WRO"}, "count"=>1}, {"key"=>{"date_booked"=>{"y"=>2012, "m"=>11}, "provider"=>"WOTRA", "tlc"=>"LAX"}, "count"=>6}, {"key"=>{"date_booked"=>{"y"=>2012, "m"=>10}, "provider"=>"GTA", "tlc"=>"WRO"}, "count"=>6}, {"key"=>{"date_booked"=>{"y"=>2012, "m"=>8}, "provider"=>"REZROOMZ", "tlc"=>"MEX"}, "count"=>1}, {"key"=>{"date_booked"=>{"y"=>2012, "m"=>9}, "provider"=>"REZROOMZ", "tlc"=>"LON"}, "count"=>1}, {"key"=>{"date_booked"=>{"y"=>2012, "m"=>12}, "provider"=>"WOTRA", "tlc"=>"VIC"}, "count"=>1}, {"key"=>{"date_booked"=>{"y"=>2012, "m"=>8}, "provider"=>"GTA", "tlc"=>"HAM"}, "count"=>1}, {"key"=>{"date_booked"=>{"y"=>2012, "m"=>12}, "provider"=>"REZROOMZ", "tlc"=>"WRO"}, "count"=>2}, {"key"=>{"date_booked"=>{"y"=>2012, "m"=>8}, "provider"=>"JACTRAVEL", "tlc"=>"BER"}, "count"=>2}, {"key"=>{"date_booked"=>{"y"=>2012, "m"=>8}, "provider"=>"REZROOMZ", "tlc"=>"BKK"}, "count"=>2}, {"key"=>{"date_booked"=>{"y"=>2012, "m"=>12}, "provider"=>"GTA", "tlc"=>"BER"}, "count"=>1}, {"key"=>{"date_booked"=>{"y"=>2012, "m"=>9}, "provider"=>"REZROOMZ", "tlc"=>"BER"}, "count"=>20}, {"key"=>{"date_booked"=>{"y"=>2012, "m"=>10}, "provider"=>"HOTELBEDS", "tlc"=>"BER"}, "count"=>4}, {"key"=>{"date_booked"=>{"y"=>2012, "m"=>10}, "provider"=>"WOTRA", "tlc"=>"MUN"}, "count"=>71}, {"key"=>{"date_booked"=>{"y"=>2012, "m"=>9}, "provider"=>"KUONI", "tlc"=>"BER"}, "count"=>2}, {"key"=>{"date_booked"=>{"y"=>2012, "m"=>9}, "provider"=>"KUONI", "tlc"=>"LON"}, "count"=>1}, {"key"=>{"date_booked"=>{"y"=>2012, "m"=>8}, "provider"=>"HOTELBEDS", "tlc"=>"MGL"}, "count"=>1}, {"key"=>{"date_booked"=>{"y"=>2012, "m"=>12}, "provider"=>"WOTRA", "tlc"=>"LON"}, "count"=>1}, {"key"=>{"date_booked"=>{"y"=>2012, "m"=>9}, "provider"=>"HOTELBEDS", "tlc"=>"BER"}, "count"=>8}, {"key"=>{"date_booked"=>{"y"=>2012, "m"=>12}, "provider"=>"WOTRA", "tlc"=>"PRG"}, "count"=>1}, {"key"=>{"date_booked"=>{"y"=>2012, "m"=>8}, "provider"=>"REZROOMZ", "tlc"=>"HAM"}, "count"=>3}, {"key"=>{"date_booked"=>{"y"=>2012, "m"=>9}, "provider"=>"REZROOMZ", "tlc"=>"WRO"}, "count"=>3}, {"key"=>{"date_booked"=>{"y"=>2012, "m"=>12}, "provider"=>"WOTRA", "tlc"=>"INN"}, "count"=>2}, {"key"=>{"date_booked"=>{"y"=>2012, "m"=>12}, "provider"=>"WOTRA", "tlc"=>"WRO"}, "count"=>1}, {"key"=>{"date_booked"=>{"y"=>2012, "m"=>12}, "provider"=>"WOTRA", "tlc"=>"BZO"}, "count"=>1}, {"key"=>{"date_booked"=>{"y"=>2012, "m"=>9}, "provider"=>"GTA", "tlc"=>"BER"}, "count"=>9}, {"key"=>{"date_booked"=>{"y"=>2012, "m"=>8}, "provider"=>"GTA", "tlc"=>"WRO"}, "count"=>1}]
  end

  it 'does something' do
    r = Reportability::Pivot.new
    r.project do |row|
      key = row['key']
      [
        "%4d-%02d" % [key['date_booked']['y'], key['date_booked']['m']],
        [key['provider'], key['tlc']],
        row['count']
      ]
    end
    t = r.call [:date_booked, :provider_tlc, :count], input
    t.cols.should == ['group_by', "2012-08", "2012-09", "2012-10", "2012-11", "2012-12"]
    t.rows.should == [['group_by', "2012-08", "2012-09", "2012-10", "2012-11", "2012-12"], [["REZROOMZ", "MUC"], 1, nil, nil, nil, nil], [["EUROTOURS", "INN"], nil, nil, nil, 5, nil], [["GTA", "LON"], 1, nil, nil, nil, nil], [["HOTELBEDS", "BER"], 4, 8, 4, nil, nil], [["HOTELBEDS", "HAM"], 2, nil, nil, nil, nil], [["MIKI", "BER"], 1, nil, nil, nil, nil], [["REZROOMZ", "BER"], 25, 20, 4, nil, nil], [["GTA", "MEX"], 1, nil, nil, nil, nil], [["TOURICO", "BER"], 1, nil, nil, nil, nil], [["WOTRA", "BZO"], nil, nil, 1, 51, 1], [["WOTRA", "BUD"], nil, nil, nil, nil, 1], [["GTA", "BER"], 8, 9, nil, nil, 1], [["GTA", "WRO"], 1, 3, 6, nil, 2], [["REZROOMZ", "ESS"], 1, nil, nil, nil, nil], [["WOTRA", "MUN"], nil, nil, 71, 1, nil], [["HOTELBEDS", "MUC"], 1, nil, nil, nil, nil], [["REZROOMZ", "LON"], 1, 1, nil, nil, nil], [["REZROOMZ", "WRO"], 1, 3, 6, nil, 2], [["REZROOMZ", "MGL"], 1, nil, nil, nil, nil], [["KUONI", "RSE"], 6, nil, nil, nil, nil], [["GTA", "BKK"], 2, nil, nil, nil, nil], [["WOTRA", "VIE"], nil, nil, nil, nil, 1], [["JACTRAVEL", "BER"], 2, 1, nil, nil, nil], [["KUONI", "BER"], 1, 2, nil, nil, nil], [["WOTRA", "LAX"], nil, nil, nil, 6, nil], [["REZROOMZ", "MEX"], 1, nil, nil, nil, nil], [["WOTRA", "VIC"], nil, nil, nil, nil, 1], [["GTA", "HAM"], 1, nil, nil, nil, nil], [["REZROOMZ", "BKK"], 2, nil, nil, nil, nil], [["KUONI", "LON"], nil, 1, nil, nil, nil], [["HOTELBEDS", "MGL"], 1, nil, nil, nil, nil], [["WOTRA", "LON"], nil, nil, nil, nil, 1], [["WOTRA", "PRG"], nil, nil, nil, nil, 1], [["REZROOMZ", "HAM"], 3, nil, nil, nil, nil], [["WOTRA", "INN"], nil, nil, nil, nil, 2], [["WOTRA", "WRO"], nil, nil, nil, nil, 1]]
  end

  it 'supports procs in projections' do
   transformer = ->row {
      key = row['key']
      [
        "%4d-%02d" % [key['date_booked']['y'], key['date_booked']['m']],
        [key['provider'], key['tlc']],
        row['count']
      ]
   }
   r = Reportability::Pivot.new
    r.project = transformer
    t = r.call [:date_booked, :provider_tlc, :count], input
    t.cols.should == ['group_by', "2012-08", "2012-09", "2012-10", "2012-11", "2012-12"]
    t.rows.should == [['group_by', "2012-08", "2012-09", "2012-10", "2012-11", "2012-12"], [["REZROOMZ", "MUC"], 1, nil, nil, nil, nil], [["EUROTOURS", "INN"], nil, nil, nil, 5, nil], [["GTA", "LON"], 1, nil, nil, nil, nil], [["HOTELBEDS", "BER"], 4, 8, 4, nil, nil], [["HOTELBEDS", "HAM"], 2, nil, nil, nil, nil], [["MIKI", "BER"], 1, nil, nil, nil, nil], [["REZROOMZ", "BER"], 25, 20, 4, nil, nil], [["GTA", "MEX"], 1, nil, nil, nil, nil], [["TOURICO", "BER"], 1, nil, nil, nil, nil], [["WOTRA", "BZO"], nil, nil, 1, 51, 1], [["WOTRA", "BUD"], nil, nil, nil, nil, 1], [["GTA", "BER"], 8, 9, nil, nil, 1], [["GTA", "WRO"], 1, 3, 6, nil, 2], [["REZROOMZ", "ESS"], 1, nil, nil, nil, nil], [["WOTRA", "MUN"], nil, nil, 71, 1, nil], [["HOTELBEDS", "MUC"], 1, nil, nil, nil, nil], [["REZROOMZ", "LON"], 1, 1, nil, nil, nil], [["REZROOMZ", "WRO"], 1, 3, 6, nil, 2], [["REZROOMZ", "MGL"], 1, nil, nil, nil, nil], [["KUONI", "RSE"], 6, nil, nil, nil, nil], [["GTA", "BKK"], 2, nil, nil, nil, nil], [["WOTRA", "VIE"], nil, nil, nil, nil, 1], [["JACTRAVEL", "BER"], 2, 1, nil, nil, nil], [["KUONI", "BER"], 1, 2, nil, nil, nil], [["WOTRA", "LAX"], nil, nil, nil, 6, nil], [["REZROOMZ", "MEX"], 1, nil, nil, nil, nil], [["WOTRA", "VIC"], nil, nil, nil, nil, 1], [["GTA", "HAM"], 1, nil, nil, nil, nil], [["REZROOMZ", "BKK"], 2, nil, nil, nil, nil], [["KUONI", "LON"], nil, 1, nil, nil, nil], [["HOTELBEDS", "MGL"], 1, nil, nil, nil, nil], [["WOTRA", "LON"], nil, nil, nil, nil, 1], [["WOTRA", "PRG"], nil, nil, nil, nil, 1], [["REZROOMZ", "HAM"], 3, nil, nil, nil, nil], [["WOTRA", "INN"], nil, nil, nil, nil, 2], [["WOTRA", "WRO"], nil, nil, nil, nil, 1]]
  end
end
